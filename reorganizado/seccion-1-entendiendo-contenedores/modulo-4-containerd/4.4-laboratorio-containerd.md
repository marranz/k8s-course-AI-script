# 4.4 Laboratorio con Containerd

## Objetivos del Laboratorio

- Configurar un entorno con containerd
- Aprender a usar `ctr` (CLI de containerd)
- Comparar operaciones entre Docker y containerd
- Entender cómo containerd opera en un contexto real

## Requisitos Previos

- Acceso a una máquina Linux (Ubuntu/Debian recomendado)
- Permisos de superusuario (sudo)
- Conocimientos básicos de línea de comandos

## Parte 1: Instalación de Containerd

### En Ubuntu/Debian

```bash
# Actualizar paquetes
sudo apt-get update

# Instalar dependencias
sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common

# Instalar containerd
sudo apt-get install -y containerd

# Verificar instalación
sudo systemctl status containerd

# Verificar versión
containerd --version
```

### Configuración Básica

```bash
# Crear directorio de configuración
sudo mkdir -p /etc/containerd

# Generar configuración por defecto
containerd config default | sudo tee /etc/containerd/config.toml

# Reiniciar containerd
sudo systemctl restart containerd
```

## Parte 2: Usando ctr - CLI de Containerd

### Trabajar con Imágenes

#### 2.1 Descargar Imágenes

```bash
# Sintaxis: ctr images pull <imagen>
sudo ctr images pull docker.io/library/nginx:latest
sudo ctr images pull docker.io/library/alpine:latest
sudo ctr images pull docker.io/library/redis:alpine
```

**Nota:** A diferencia de Docker, debes especificar el registro completo (docker.io).

#### 2.2 Listar Imágenes

```bash
# Listar todas las imágenes
sudo ctr images ls

# Ver más detalles
sudo ctr images ls -q
```

**Comparación con Docker:**
```bash
# Docker
docker images

# Containerd
sudo ctr images ls
```

#### 2.3 Etiquetar Imágenes

```bash
# Etiquetar una imagen
sudo ctr images tag docker.io/library/nginx:latest mi-nginx:v1
```

#### 2.4 Eliminar Imágenes

```bash
# Eliminar una imagen
sudo ctr images rm docker.io/library/alpine:latest

# Verificar
sudo ctr images ls
```

### Trabajar con Contenedores

#### 2.5 Crear y Ejecutar Contenedores

**Importante:** `ctr` requiere especificar un namespace (por defecto: `default`).

```bash
# Ejecutar un contenedor básico
sudo ctr run docker.io/library/alpine:latest mi-contenedor

# Ejecutar con terminal interactiva
sudo ctr run -t docker.io/library/alpine:latest mi-alpine sh

# Dentro del contenedor:
ls
ps
exit
```

#### 2.6 Ejecutar en Segundo Plano

```bash
# Ejecutar nginx en segundo plano
sudo ctr run -d docker.io/library/nginx:latest nginx-web

# Verificar que está corriendo
sudo ctr tasks ls
```

#### 2.7 Listar Contenedores

```bash
# Listar contenedores
sudo ctr containers ls

# Listar tareas (procesos) en ejecución
sudo ctr tasks ls
```

**Comparación con Docker:**
```bash
# Docker
docker ps

# Containerd - contenedores
sudo ctr containers ls

# Containerd - procesos en ejecución
sudo ctr tasks ls
```

#### 2.8 Ejecutar Comandos en Contenedores

```bash
# Ejecutar comando en contenedor corriendo
sudo ctr tasks exec --exec-id proceso1 nginx-web ls /usr/share/nginx/html
```

**Nota:** Con `ctr` necesitas especificar un `--exec-id` único para cada ejecución.

#### 2.9 Detener y Eliminar Contenedores

```bash
# Detener una tarea
sudo ctr tasks kill nginx-web

# Eliminar la tarea
sudo ctr tasks rm nginx-web

# Eliminar el contenedor
sudo ctr containers rm nginx-web
```

**Comparación con Docker:**
```bash
# Docker (un solo comando)
docker rm -f nginx-web

# Containerd (tres pasos)
sudo ctr tasks kill nginx-web
sudo ctr tasks rm nginx-web
sudo ctr containers rm nginx-web
```

## Parte 3: Namespaces en Containerd

Containerd usa namespaces para aislar recursos.

```bash
# Listar en el namespace por defecto
sudo ctr -n default containers ls

# Listar en el namespace de Kubernetes (si existe)
sudo ctr -n k8s.io containers ls

# Crear contenedor en namespace personalizado
sudo ctr -n mi-proyecto run docker.io/library/alpine:latest test1 echo "Hola"

# Verificar
sudo ctr -n mi-proyecto containers ls
```

**Namespaces comunes:**
- `default` - Por defecto
- `k8s.io` - Usado por Kubernetes
- Personalizados - Puedes crear los tuyos

## Parte 4: Comparación Docker vs Containerd

### Tabla de Comandos Equivalentes

| Operación | Docker | Containerd (ctr) |
|-----------|--------|------------------|
| Descargar imagen | `docker pull nginx` | `sudo ctr images pull docker.io/library/nginx:latest` |
| Listar imágenes | `docker images` | `sudo ctr images ls` |
| Ejecutar contenedor | `docker run -d nginx` | `sudo ctr run -d docker.io/library/nginx:latest nombre` |
| Listar contenedores | `docker ps` | `sudo ctr containers ls` + `sudo ctr tasks ls` |
| Detener contenedor | `docker stop nombre` | `sudo ctr tasks kill nombre` |
| Eliminar contenedor | `docker rm nombre` | `sudo ctr tasks rm nombre && sudo ctr containers rm nombre` |
| Ver logs | `docker logs nombre` | No disponible directamente en `ctr` |

## Parte 5: Usando crictl (Herramienta CRI)

`crictl` es una herramienta que implementa la interfaz CRI, similar a cómo Kubernetes interactúa con containerd.

### Instalar crictl

```bash
# Descargar crictl
VERSION="v1.28.0"
wget https://github.com/kubernetes-sigs/cri-tools/releases/download/$VERSION/crictl-$VERSION-linux-amd64.tar.gz

# Extraer
sudo tar zxvf crictl-$VERSION-linux-amd64.tar.gz -C /usr/local/bin
rm -f crictl-$VERSION-linux-amd64.tar.gz

# Verificar
crictl --version
```

### Configurar crictl

```bash
# Crear archivo de configuración
sudo tee /etc/crictl.yaml <<EOF
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
timeout: 10
debug: false
EOF
```

### Usar crictl

```bash
# Listar imágenes
sudo crictl images

# Descargar imagen
sudo crictl pull nginx:alpine

# Listar contenedores
sudo crictl ps
sudo crictl ps -a

# Ver información de un contenedor
sudo crictl inspect <container_id>

# Ver logs (si están disponibles)
sudo crictl logs <container_id>
```

**Ventaja de crictl:**
- Sintaxis más similar a Docker
- Comandos como `logs` están disponibles
- Es la herramienta que usa Kubernetes internamente

## Parte 6: Ejercicios Prácticos

### Ejercicio 1: Gestión Básica

1. Descarga la imagen de Alpine Linux
2. Lista las imágenes disponibles
3. Crea un contenedor que ejecute `echo "Hola containerd"`
4. Limpia los recursos

### Ejercicio 2: Servidor Web

1. Descarga la imagen de nginx
2. Ejecuta nginx en segundo plano
3. Lista las tareas en ejecución
4. Detén y elimina el contenedor

### Ejercicio 3: Namespaces

1. Crea dos contenedores en namespaces diferentes
2. Lista contenedores en cada namespace
3. Verifica que están aislados
4. Limpia ambos namespaces

### Ejercicio 4: Comparación

Realiza la misma operación con Docker y containerd:
1. Descarga una imagen
2. Ejecuta un contenedor
3. Verifica que está corriendo
4. Elimínalo
5. Compara los pasos necesarios

## Parte 7: Explorar Containerd en Docker Desktop

Si tienes Docker Desktop instalado, puedes explorar containerd que está corriendo por debajo.

```bash
# En Docker Desktop, puedes acceder a containerd
docker run -it --rm --privileged --pid=host alpine nsenter -t 1 -m -u -n -i sh

# Dentro del contenedor:
ctr -n moby containers ls
ctr -n moby images ls
```

**Nota:** El namespace `moby` es usado por Docker Engine.

## Parte 8: Observaciones y Aprendizajes

### Diferencias Clave

1. **Complejidad:**
   - Docker CLI es más user-friendly
   - `ctr` es más bajo nivel y requiere más pasos

2. **Namespaces:**
   - containerd usa namespaces explícitos
   - Docker abstrae esto del usuario

3. **Ciclo de vida:**
   - En containerd, contenedores y tareas son conceptos separados
   - Docker los maneja juntos

4. **Propósito:**
   - `ctr` es para debugging y testing
   - No está diseñado para uso diario como Docker CLI

### Cuándo Usar Cada Uno

**Usar Docker CLI cuando:**
- Desarrollo local
- Necesitas facilidad de uso
- Trabajas con Docker Compose

**Usar containerd/ctr cuando:**
- Debugging de bajo nivel
- Entorno de producción con Kubernetes
- Necesitas máximo control

**Usar crictl cuando:**
- Trabajas con Kubernetes
- Necesitas debugging compatible con CRI
- Quieres sintaxis similar a Docker

## Conclusiones del Laboratorio

Has aprendido:
- ✅ Cómo instalar y configurar containerd
- ✅ Usar `ctr` para operaciones básicas
- ✅ La diferencia entre contenedores y tareas
- ✅ Trabajar con namespaces
- ✅ Comparar Docker y containerd
- ✅ Usar `crictl` como alternativa

Containerd es fundamental en el ecosistema moderno de contenedores, especialmente en Kubernetes, aunque Docker sigue siendo la mejor opción para desarrollo local.

## Recursos Adicionales

- [Documentación oficial de containerd](https://containerd.io/)
- [GitHub de containerd](https://github.com/containerd/containerd)
- [Documentación de crictl](https://github.com/kubernetes-sigs/cri-tools)
- [Comparación de runtimes](https://kubernetes.io/docs/setup/production-environment/container-runtimes/)
