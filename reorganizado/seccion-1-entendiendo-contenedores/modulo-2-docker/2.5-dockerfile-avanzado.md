# 2.3b Dockerfile Avanzado

## IntroducciÃ³n

En la secciÃ³n bÃ¡sica aprendimos a crear un Dockerfile simple. Ahora profundizaremos en tÃ©cnicas avanzadas que te permitirÃ¡n crear imÃ¡genes optimizadas, seguras y eficientes para producciÃ³n.

## Instrucciones Completas de Dockerfile

### FROM - Imagen Base

```dockerfile
# VersiÃ³n especÃ­fica (recomendado)
FROM node:18.17.0-alpine

# MÃºltiples FROMs (multi-stage builds)
FROM node:18 AS builder
FROM nginx:alpine AS production

# Usar ARG antes de FROM
ARG NODE_VERSION=18
FROM node:${NODE_VERSION}-alpine
```

**Mejores prÃ¡cticas:**
- âœ… Usa versiones especÃ­ficas (`18.17.0`, no `latest`)
- âœ… Prefiere imÃ¡genes `alpine` (mÃ¡s pequeÃ±as)
- âœ… Usa imÃ¡genes oficiales cuando sea posible

### WORKDIR - Directorio de Trabajo

```dockerfile
# Establecer directorio de trabajo
WORKDIR /app

# Todas las rutas siguientes serÃ¡n relativas a /app
COPY package.json .
RUN npm install
```

**Ventajas:**
- OrganizaciÃ³n clara
- Evita rutas absolutas repetitivas
- Crea el directorio si no existe

### COPY vs ADD

```dockerfile
# COPY - Recomendado para archivos locales
COPY package.json package-lock.json ./
COPY src/ ./src/

# Copiar con permisos especÃ­ficos
COPY --chown=node:node app.js .

# ADD - Solo para casos especiales
# Extrae automÃ¡ticamente archivos .tar
ADD archive.tar.gz /app/

# Descargar desde URL (no recomendado, usa RUN curl)
ADD https://example.com/file.txt /app/
```

**Regla:** Usa `COPY` a menos que necesites auto-extracciÃ³n de tar

### RUN - Ejecutar Comandos

```dockerfile
# Una lÃ­nea
RUN npm install

# MÃºltiples comandos (mala prÃ¡ctica)
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get install -y git

# MÃºltiples comandos (buena prÃ¡ctica - una sola capa)
RUN apt-get update && \
    apt-get install -y \
      curl \
      git \
      vim && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
```

**OptimizaciÃ³n:**
```dockerfile
# Combinar comandos relacionados
RUN apt-get update && apt-get install -y \
    package1 \
    package2 \
    package3 \
    && rm -rf /var/lib/apt/lists/*

# Usar continuaciÃ³n de lÃ­nea para legibilidad
RUN npm install && \
    npm run build && \
    npm prune --production
```

### ENV - Variables de Entorno

```dockerfile
# Establecer variables de entorno
ENV NODE_ENV=production
ENV PORT=3000
ENV API_URL=https://api.example.com

# MÃºltiples variables
ENV NODE_ENV=production \
    PORT=3000 \
    API_URL=https://api.example.com

# Disponibles en tiempo de build y runtime
RUN echo "Running in $NODE_ENV mode"
```

**Diferencia con ARG:**
- `ENV`: Persiste en el contenedor final
- `ARG`: Solo disponible durante build

### ARG - Argumentos de Build

```dockerfile
# Definir argumentos
ARG NODE_VERSION=18
ARG BUILD_DATE
ARG VERSION=1.0.0

# Usar en FROM
FROM node:${NODE_VERSION}-alpine

# Usar en RUN
RUN echo "Building version ${VERSION} on ${BUILD_DATE}"

# Valores por defecto
ARG ENVIRONMENT=development
```

**Usar en build:**
```bash
docker build \
  --build-arg NODE_VERSION=20 \
  --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
  --build-arg VERSION=2.0.0 \
  -t myapp:2.0.0 .
```

**ARG vs ENV:**
```dockerfile
# ARG - Solo build time
ARG APP_VERSION=1.0

# ENV puede usar ARG
ENV VERSION=$APP_VERSION

# ARG desaparece despuÃ©s del build
# ENV persiste en el contenedor
```

### EXPOSE - Documentar Puertos

```dockerfile
# Documentar puerto TCP
EXPOSE 3000

# MÃºltiples puertos
EXPOSE 80 443

# Especificar protocolo
EXPOSE 53/udp
EXPOSE 8080/tcp

# NO mapea puertos automÃ¡ticamente
# Solo documenta la intenciÃ³n
```

**Uso:**
```bash
# Mapeo manual necesario
docker run -p 8080:3000 myapp

# O automÃ¡tico con -P
docker run -P myapp  # Mapea todos los EXPOSE a puertos random
```

### USER - Usuario de EjecuciÃ³n

```dockerfile
# Crear usuario no-root
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# Cambiar a ese usuario
USER nodejs

# Todo lo siguiente se ejecuta como 'nodejs'
WORKDIR /app
CMD ["node", "server.js"]
```

**Seguridad crÃ­tica:**
```dockerfile
# âŒ MAL - ejecuta como root
FROM node:18-alpine
COPY . .
CMD ["node", "app.js"]

# âœ… BIEN - ejecuta como usuario no privilegiado
FROM node:18-alpine
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001
WORKDIR /app
COPY --chown=nodejs:nodejs . .
USER nodejs
CMD ["node", "app.js"]
```

### VOLUME - Puntos de Montaje

```dockerfile
# Declarar volumen
VOLUME /data

# MÃºltiples volÃºmenes
VOLUME ["/data", "/logs"]
```

**Comportamiento:**
- Datos en `/data` persisten aunque el contenedor se elimine
- Docker crea volumen anÃ³nimo automÃ¡ticamente
- Mejor declarar volÃºmenes en `docker run` o Compose

### HEALTHCHECK - VerificaciÃ³n de Salud

```dockerfile
# VerificaciÃ³n HTTP
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# VerificaciÃ³n con script
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s \
  CMD node healthcheck.js

# Desactivar healthcheck heredado
HEALTHCHECK NONE
```

**ParÃ¡metros:**
- `--interval`: Tiempo entre checks (default: 30s)
- `--timeout`: Tiempo mÃ¡ximo de espera (default: 30s)
- `--start-period`: Tiempo de gracia inicial (default: 0s)
- `--retries`: Fallos antes de marcar unhealthy (default: 3)

**Ejemplo completo:**
```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .

# Health check que llama a endpoint
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

EXPOSE 3000
CMD ["node", "server.js"]
```

### CMD vs ENTRYPOINT

#### CMD - Comando por Defecto

```dockerfile
# Forma exec (recomendada)
CMD ["node", "server.js"]

# Forma shell
CMD node server.js

# Con argumentos
CMD ["npm", "start"]
```

**Puede ser sobrescrito:**
```bash
docker run myapp node other-script.js  # Ignora CMD del Dockerfile
```

#### ENTRYPOINT - Punto de Entrada

```dockerfile
# Forma exec
ENTRYPOINT ["node"]

# Combinado con CMD (args por defecto)
ENTRYPOINT ["node"]
CMD ["server.js"]
```

**No puede ser sobrescrito fÃ¡cilmente:**
```bash
# Ejecuta: node other-script.js
docker run myapp other-script.js

# ENTRYPOINT fija "node", CMD proporciona argumentos
```

#### Patrones Comunes

**PatrÃ³n 1: Script ejecutable**
```dockerfile
COPY docker-entrypoint.sh /
RUN chmod +x /docker-entrypoint.sh

ENTRYPOINT ["/docker-entrypoint.sh"]
CMD ["start"]
```

**PatrÃ³n 2: AplicaciÃ³n con argumentos flexibles**
```dockerfile
ENTRYPOINT ["python", "app.py"]
CMD ["--port", "8000"]

# docker run myapp --port 9000  # Sobrescribe CMD
```

**PatrÃ³n 3: Wrapper script**
```dockerfile
ENTRYPOINT ["docker-entrypoint.sh"]
CMD ["node", "server.js"]
```

## Multi-Stage Builds

ConstrucciÃ³n en mÃºltiples etapas para optimizar tamaÃ±o de imagen.

### Ejemplo BÃ¡sico

```dockerfile
# Etapa 1: Build
FROM node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Etapa 2: Production
FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/node_modules ./node_modules
EXPOSE 3000
CMD ["node", "dist/server.js"]
```

**Ventajas:**
- âœ… Imagen final mÃ¡s pequeÃ±a
- âœ… No incluye herramientas de build
- âœ… MÃ¡s segura (menos superficie de ataque)

### Ejemplo Avanzado: AplicaciÃ³n React + Node.js

```dockerfile
# Etapa 1: Build del frontend
FROM node:18 AS frontend-builder
WORKDIR /frontend
COPY frontend/package*.json ./
RUN npm ci
COPY frontend/ ./
RUN npm run build

# Etapa 2: Build del backend
FROM node:18 AS backend-builder
WORKDIR /backend
COPY backend/package*.json ./
RUN npm ci --only=production
COPY backend/ ./

# Etapa 3: Imagen de producciÃ³n
FROM node:18-alpine
WORKDIR /app

# Copiar solo lo necesario del backend
COPY --from=backend-builder /backend/node_modules ./node_modules
COPY --from=backend-builder /backend/src ./src

# Copiar build del frontend
COPY --from=frontend-builder /frontend/dist ./public

# Usuario no root
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001
USER nodejs

EXPOSE 3000
HEALTHCHECK --interval=30s --timeout=3s \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

CMD ["node", "src/server.js"]
```

### Ejemplo: Go Application

```dockerfile
# Etapa 1: Build
FROM golang:1.21 AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# Etapa 2: Imagen mÃ­nima
FROM alpine:3.18
RUN apk --no-cache add ca-certificates
WORKDIR /root/
COPY --from=builder /app/main .
EXPOSE 8080
CMD ["./main"]
```

**ComparaciÃ³n de tamaÃ±os:**
- Single-stage (golang:1.21): ~900MB
- Multi-stage (alpine:3.18): ~15MB

## OptimizaciÃ³n de Capas

### Orden Importa

```dockerfile
# âŒ MAL - invalida cache frecuentemente
FROM node:18-alpine
WORKDIR /app
COPY . .
RUN npm install

# âœ… BIEN - maximiza cache
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./  # Solo cambia cuando cambian dependencias
RUN npm ci              # Cache se mantiene si package.json no cambiÃ³
COPY . .                # Copiar cÃ³digo al final
```

### Minimizar Capas

```dockerfile
# âŒ MAL - muchas capas
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get install -y git
RUN apt-get clean

# âœ… BIEN - una capa
RUN apt-get update && \
    apt-get install -y curl git && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
```

### Eliminar Archivos Temporales

```dockerfile
# En la misma capa
RUN wget https://example.com/file.tar.gz && \
    tar -xzf file.tar.gz && \
    mv file /usr/local/bin/ && \
    rm file.tar.gz  # Eliminado en la misma capa

# Si lo haces en capas separadas, el tamaÃ±o no disminuye
```

## .dockerignore

Archivo para excluir archivos del contexto de build.

### Ejemplo Completo

```dockerignore
# Dependencias
node_modules/
npm-debug.log
yarn-error.log

# Build outputs
dist/
build/
*.log

# Archivos de desarrollo
.env
.env.local
.env.*.local

# Git
.git/
.gitignore
.gitattributes

# IDE
.vscode/
.idea/
*.swp
*.swo

# Testing
coverage/
.nyc_output/

# OS
.DS_Store
Thumbs.db

# Docker
Dockerfile
.dockerignore
docker-compose.yml

# DocumentaciÃ³n
README.md
docs/
*.md

# CI/CD
.github/
.gitlab-ci.yml
.travis.yml
```

**Beneficios:**
- âš¡ Build mÃ¡s rÃ¡pido (menos archivos a enviar)
- ðŸ”’ MÃ¡s seguro (no incluye secretos accidentalmente)
- ðŸ“¦ Imagen mÃ¡s pequeÃ±a

## Cache Busting

Forzar descarga de recursos nuevos.

```dockerfile
# Sin cache busting - puede usar versiÃ³n vieja
RUN curl https://example.com/script.sh | sh

# Con cache busting - siempre descarga nuevo
ARG CACHE_DATE=not_set
RUN echo "Cache bust: ${CACHE_DATE}" && \
    curl https://example.com/script.sh | sh
```

**Build con fecha:**
```bash
docker build --build-arg CACHE_DATE=$(date +%Y-%m-%d) -t myapp .
```

## Ejemplos PrÃ¡cticos por Lenguaje

### Node.js + Express

```dockerfile
FROM node:18-alpine AS builder

WORKDIR /app

# Dependencias primero (mejor cache)
COPY package*.json ./
RUN npm ci --only=production

# CÃ³digo fuente
COPY . .

# Build si es necesario
RUN npm run build 2>/dev/null || true

# Imagen final
FROM node:18-alpine

# Usuario no root
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

WORKDIR /app

# Copiar desde builder
COPY --from=builder --chown=nodejs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nodejs:nodejs /app/dist ./dist
COPY --from=builder --chown=nodejs:nodejs /app/package.json ./

USER nodejs

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"

CMD ["node", "dist/server.js"]
```

### Python + Flask

```dockerfile
FROM python:3.11-slim AS builder

WORKDIR /app

# Instalar dependencias de sistema
RUN apt-get update && \
    apt-get install -y --no-install-recommends gcc && \
    rm -rf /var/lib/apt/lists/*

# Dependencias Python
COPY requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

# Imagen final
FROM python:3.11-slim

# Usuario no root
RUN useradd -m -u 1001 appuser

WORKDIR /app

# Copiar dependencias instaladas
COPY --from=builder /root/.local /home/appuser/.local
ENV PATH=/home/appuser/.local/bin:$PATH

# Copiar cÃ³digo
COPY --chown=appuser:appuser . .

USER appuser

EXPOSE 5000

HEALTHCHECK --interval=30s --timeout=3s \
  CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:5000/health').read()"

CMD ["python", "app.py"]
```

### Java + Spring Boot

```dockerfile
FROM maven:3.9-eclipse-temurin-17 AS builder

WORKDIR /app

# Dependencias primero
COPY pom.xml .
RUN mvn dependency:go-offline

# CÃ³digo y build
COPY src ./src
RUN mvn clean package -DskipTests

# Imagen final con JRE (mÃ¡s pequeÃ±a que JDK)
FROM eclipse-temurin:17-jre-alpine

RUN addgroup -g 1001 -S spring && \
    adduser -S spring -u 1001

WORKDIR /app

COPY --from=builder --chown=spring:spring /app/target/*.jar app.jar

USER spring

EXPOSE 8080

HEALTHCHECK --interval=30s --timeout=3s --start-period=40s \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1

ENTRYPOINT ["java", "-jar", "app.jar"]
```

## Mejores PrÃ¡cticas Resumen

### Seguridad
1. âœ… No ejecutar como root (USER)
2. âœ… Usar imÃ¡genes oficiales y verificadas
3. âœ… Escanear vulnerabilidades (`docker scan`)
4. âœ… No incluir secretos en la imagen
5. âœ… Usar imÃ¡genes especÃ­ficas (no `latest`)
6. âœ… Minimizar paquetes instalados

### Rendimiento
1. âœ… Multi-stage builds
2. âœ… Orden optimizado (cache)
3. âœ… Combinar RUN commands
4. âœ… Usar .dockerignore
5. âœ… Preferir alpine/slim variants

### Mantenibilidad
1. âœ… Documentar con comentarios
2. âœ… Versiones especÃ­ficas de dependencias
3. âœ… HEALTHCHECK incluido
4. âœ… Labels para metadata
5. âœ… Usar ARG para flexibilidad

### Checklist Final

```dockerfile
# âœ… VersiÃ³n especÃ­fica de imagen base
FROM node:18.17.0-alpine

# âœ… Labels para metadata
LABEL maintainer="tu@email.com"
LABEL version="1.0"

# âœ… Usuario no root
RUN addgroup -g 1001 -S nodejs && \
    adduser -S nodejs -u 1001

# âœ… WORKDIR definido
WORKDIR /app

# âœ… Dependencias antes del cÃ³digo (cache)
COPY package*.json ./
RUN npm ci --only=production

# âœ… Copiar cÃ³digo
COPY --chown=nodejs:nodejs . .

# âœ… Cambiar a usuario no root
USER nodejs

# âœ… Puerto documentado
EXPOSE 3000

# âœ… Health check incluido
HEALTHCHECK --interval=30s --timeout=3s \
  CMD node healthcheck.js

# âœ… CMD en formato exec
CMD ["node", "server.js"]
```

## Recursos Adicionales

- [Dockerfile Best Practices (oficial)](https://docs.docker.com/develop/dev-best-practices/)
- [Multi-stage builds](https://docs.docker.com/build/building/multi-stage/)
- [Dockerfile reference](https://docs.docker.com/engine/reference/builder/)
