# 2.6 Redes en Docker: Conectividad entre Contenedores y el Exterior

## Sistema de Redes de Docker

Docker proporciona un sistema en el que podemos gestionar las redes que utiliza tanto para comunicación entre contenedores como para comunicarse con el exterior.

## Red por Defecto: Bridge

Por defecto, al crear un contenedor, este se va a conectar a la **red predeterminada**, normalmente **bridge**. Esto hace que:
- El contenedor obtenga una IP de una subred asignada por Docker
- Pueda comunicarse con el exterior

Para la comunicación **desde el exterior a los puertos del contenedor**, tendremos que **exponerlos**.

## Tipos de Redes en Docker

### 1. Bridge (por defecto)
- Red privada interna en el host
- Los contenedores pueden comunicarse entre sí
- Necesitan port mapping para ser accesibles desde el exterior

### 2. Host
- El contenedor comparte la red del host
- No hay aislamiento de red
- Mejor rendimiento (sin overhead de virtualización)
- Los puertos del contenedor están directamente en el host

### 3. None
- El contenedor está completamente aislado a nivel de red
- No tiene acceso a la red
- Útil para contenedores que no necesitan conectividad

### 4. User-Defined Bridge Networks
Existen arquitecturas más complejas donde podríamos definir **redes personalizadas**, como por ejemplo:
- Una red para nuestra base de datos
- Una red para nuestro servidor web

Esto haría que podamos configurar reglas más complejas y granulares donde definimos a dónde y desde dónde podrán tener conectividad los contenedores de estas redes. Estas redes las conocemos como **user-defined bridge networks** y no las veremos durante el curso.

## Exposición de Puertos

### EXPOSE en Dockerfile

Como dijimos, para poder acceder a los servicios de un contenedor por red, necesitamos **exponer los puertos**. Podemos especificar los puertos que una aplicación necesita usando la instrucción `EXPOSE` en un Dockerfile.

```dockerfile
FROM nginx:alpine
EXPOSE 80
EXPOSE 443
```

Más tarde, al lanzar un contenedor basado en una imagen creada a través de ese Dockerfile, Docker sabrá qué puertos tiene que exponer, aunque no es necesario definirlos, es recomendable.

### Mapeo de Puertos

Al ejecutar un contenedor, podemos mapear puertos del host a puertos del contenedor:

```bash
# Mapeo automático de todos los puertos expuestos
docker run -P nginx

# Mapeo específico: puerto_host:puerto_contenedor
docker run -p 8080:80 nginx

# Múltiples puertos
docker run -p 8080:80 -p 8443:443 nginx

# Especificar IP del host
docker run -p 127.0.0.1:8080:80 nginx
```

## Demostración Práctica

### Demo 1: EXPOSE en Dockerfile

1. **Crear un Dockerfile con EXPOSE**
   ```dockerfile
   FROM nginx:alpine
   EXPOSE 80
   ```

2. **Construir la imagen**
   ```bash
   docker build -t mi-nginx .
   ```

3. **Crear el contenedor y exponer el puerto con -P**
   ```bash
   docker run -d -P --name web1 mi-nginx
   docker ps
   # Verá que Docker asignó un puerto aleatorio del host
   ```

### Demo 2: Especificar el puerto a mapear

```bash
# Mapear el puerto 8080 del host al puerto 80 del contenedor
docker run -d -p 8080:80 --name web2 nginx

# Verificar
curl http://localhost:8080
```

### Demo 3: Comunicación entre contenedores

```bash
# Crear una red personalizada
docker network create mi-red

# Crear un contenedor de base de datos
docker run -d --name db --network mi-red postgres

# Crear un contenedor de aplicación en la misma red
docker run -d --name app --network mi-red mi-aplicacion

# Desde 'app', puedes conectarte a 'db' usando su nombre
```

## Comandos Útiles de Red

```bash
# Listar redes
docker network ls

# Inspeccionar una red
docker network inspect bridge

# Crear una red personalizada
docker network create mi-red

# Conectar un contenedor a una red
docker network connect mi-red contenedor1

# Desconectar un contenedor de una red
docker network disconnect mi-red contenedor1

# Eliminar una red
docker network rm mi-red
```

## Mejores Prácticas

1. **Usar redes personalizadas** para mejor aislamiento y resolución DNS
2. **No exponer puertos innecesarios** - solo los que realmente necesitas
3. **En producción**, considera usar redes específicas para diferentes capas de la aplicación
4. **Documentar los puertos** usados en el Dockerfile con EXPOSE
