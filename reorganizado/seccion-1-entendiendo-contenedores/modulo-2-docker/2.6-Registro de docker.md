# 2.6 Docker Registry

## Introducción

Hasta ahora hemos creado imágenes de Docker localmente en nuestra máquina. Pero ¿qué pasa cuando queremos compartir estas imágenes con otros desarrolladores, desplegarlas en servidores de producción, o trabajar en equipo?

Para esto existen los **registros de Docker** (Docker Registries), que son almacenes centralizados donde podemos guardar, versionar y compartir nuestras imágenes Docker.

En esta sección aprenderemos qué son, cómo funcionan, y cómo usar el registro más popular: **Docker Hub**.

---

## ¿Qué es un Docker Registry?

Un **Docker Registry** es un servidor que almacena y distribuye imágenes Docker. Es como un almacén centralizado donde:

- **Subes** (push) tus imágenes compiladas
- **Descargas** (pull) imágenes que otros han creado
- **Organizas** tus imágenes en repositorios
- **Versionas** tus imágenes con etiquetas (tags)

### Tipos de Registros

Existen dos tipos principales de registros:

#### 1. Registros Públicos
- Cualquiera puede descargar las imágenes
- Las imágenes son visibles para el mundo
- Perfecto para proyectos open source

#### 2. Registros Privados
- Solo usuarios autenticados pueden acceder
- Las imágenes no son visibles públicamente
- Ideal para aplicaciones empresariales y código propietario

---

## Docker Hub

### ¿Qué es Docker Hub?

**Docker Hub** es el registro oficial de Docker, alojado en la nube y completamente gratuito (con opciones de pago para funcionalidades avanzadas).

Es el registro público más popular y donde encontrarás miles de imágenes:
- **Imágenes Oficiales**: nginx, node, python, ubuntu, etc.
- **Imágenes Certificadas**: creadas por empresas verificadas
- **Imágenes de Comunidad**: creadas por desarrolladores individuales

### Ventajas de Docker Hub

- ✅ **Gratuito** - Almacenamiento ilimitado para repositorios públicos
- ✅ **Oficial** - Creado y mantenido por Docker
- ✅ **Popular** - Millones de imágenes disponibles
- ✅ **Integración** - Funciona por defecto con `docker pull` y `docker push`
- ✅ **Automatización** - Builds automáticos desde GitHub
- ✅ **Privado** - Repositorios privados gratuitos (limitados)

---

## Anatomía de un nombre de imagen

Antes de aprender a usar registros, necesitamos entender cómo se nombran las imágenes:

```
docker.io/usuario/nombre-imagen:tag
│          │      │             │
│          │      │             └─ Etiqueta de versión (opcional, default: latest)
│          │      └──────────────── Nombre del repositorio
│          └────────────────────── Nombre del usuario/organización
└──────────────────────────────── Registro (opcional, default: docker.io)
```

### Ejemplos de nombres completos

```bash
# Imagen oficial de nginx en Docker Hub
docker.io/library/nginx:latest

# Abreviado (asume docker.io y library por defecto)
nginx:latest
nginx

# Imagen personalizada en Docker Hub
docker.io/usuario/mi-app:1.0.0

# Abreviado
usuario/mi-app:1.0.0

# Imagen en un registro privado
mi-registro.ejemplo.com/mi-app:v2.0.0

# Imagen sin especificar tag (asume latest)
usuario/mi-app
```

### Nomenclatura recomendada

```
[REGISTRO]/[USUARIO]/[REPOSITORIO]:[TAG]
```

Donde:
- **REGISTRO**: docker.io (puede omitirse), gcr.io, ecr.aws, etc.
- **USUARIO**: Tu usuario en Docker Hub (o nombre de organización)
- **REPOSITORIO**: Nombre descriptivo de tu aplicación
- **TAG**: Versión (v1.0, latest, stable, etc.)

---

## Crear una cuenta en Docker Hub

### Paso 1: Ir a Docker Hub

Abre tu navegador y ve a [https://hub.docker.com](https://hub.docker.com)

### Paso 2: Registrarse

1. Haz clic en "Sign up"
2. Rellena el formulario con:
   - Nombre de usuario (será tu USUARIO en los nombres de imágenes)
   - Email
   - Contraseña
3. Verifica tu email

### Paso 3: Crear un access token (recomendado)

En lugar de usar tu contraseña, es más seguro crear un token de acceso:

1. Ve a Settings → Security → Access Tokens
2. Haz clic en "New Access Token"
3. Dale un nombre descriptivo (ej. "mi-laptop")
4. Selecciona permisos (Read & Write)
5. Copia el token (lo necesitarás después)

---

## Login en Docker desde la terminal

### Opción 1: Autenticarse con tu contraseña

```bash
docker login
```

Te pedirá:
- Username: Tu usuario de Docker Hub
- Password: Tu contraseña

### Opción 2: Autenticarse con un token (más seguro)

```bash
docker login
```

- Username: Tu usuario de Docker Hub
- Password: El token que creaste en Docker Hub

Las credenciales se guardan en `~/.docker/config.json` (en Linux/Mac) o en la credential store de Windows.

### Verificar login

```bash
docker info | grep "Registries" -A 5
```

### Logout

```bash
docker logout
```

---

## Subir una imagen a Docker Hub (push)

### Paso 1: Crear tu imagen localmente

```bash
# Crear un Dockerfile
cat > Dockerfile << 'EOF'
FROM node:18-alpine
WORKDIR /app
COPY . .
RUN npm install
EXPOSE 3000
CMD ["node", "index.js"]
EOF

# Construir la imagen
docker build -t mi-app:1.0.0 .
```

### Paso 2: Etiquetar la imagen con tu usuario

Antes de subir a Docker Hub, necesitas etiquetar tu imagen con tu nombre de usuario:

```bash
docker tag mi-app:1.0.0 mi-usuario/mi-app:1.0.0
```

O con múltiples tags (recomendado):

```bash
docker tag mi-app:1.0.0 mi-usuario/mi-app:1.0.0
docker tag mi-app:1.0.0 mi-usuario/mi-app:latest
```

### Paso 3: Subir la imagen (push)

```bash
docker push mi-usuario/mi-app:1.0.0
docker push mi-usuario/mi-app:latest
```

Verás algo como:

```
The push refers to repository [docker.io/mi-usuario/mi-app]
a1b2c3d4: Pushed
e5f6g7h8: Pushed
1.0.0: digest: sha256:abc123... size: 2048
latest: digest: sha256:abc123... size: 2048
```

### Verificar en Docker Hub

Ve a tu perfil en [https://hub.docker.com](https://hub.docker.com) y verás tu nuevo repositorio.

---

## Descargar una imagen de Docker Hub (pull)

### Descargar una imagen oficial

```bash
# Descargar la versión latest
docker pull nginx

# Descargar una versión específica
docker pull nginx:1.25-alpine

# Descargar una imagen específica de un usuario
docker pull mi-usuario/mi-app:1.0.0
```

### Usar una imagen descargada

Una vez descargada, puedes usarla inmediatamente:

```bash
# Ejecutar un contenedor
docker run -d -p 8080:80 nginx:1.25-alpine
```

---

## Mejores prácticas con Docker Hub

### 1. Usa etiquetas específicas, no solo "latest"

```bash
# ❌ Evitar
docker tag mi-app mi-usuario/mi-app:latest

# ✅ Mejor
docker tag mi-app mi-usuario/mi-app:1.0.0
docker tag mi-app mi-usuario/mi-app:latest
```

### 2. Documenta tu imagen

- Añade un `README.md` en tu repositorio de Docker Hub
- Describe qué hace la imagen
- Incluye ejemplos de uso
- Documenta las variables de entorno

### 3. Usa imágenes base específicas

```dockerfile
# ❌ Evitar
FROM node:latest

# ✅ Mejor
FROM node:18.17.0-alpine
```

### 4. Sé consciente del tamaño

- Usa imágenes alpine cuando sea posible
- Elimina archivos innecesarios
- Usa multi-stage builds

```dockerfile
# Multi-stage build
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/dist ./dist
EXPOSE 3000
CMD ["node", "dist/index.js"]
```

### 5. Usa tokens en lugar de contraseñas

- Crea access tokens en Docker Hub
- Úsalos para autenticarte
- Más seguro y revocables

### 6. Mantén tus imágenes privadas si son propietarias

```bash
# Crear un repositorio privado en Docker Hub
# Ir a Docker Hub → Create Repository → Private
```

---

## Registros privados alternativos

Aunque Docker Hub es el más popular, existen otras opciones:

### GitHub Container Registry (GHCR)

```bash
docker login ghcr.io

docker tag mi-app ghcr.io/mi-usuario/mi-app:1.0.0
docker push ghcr.io/mi-usuario/mi-app:1.0.0
```

### GitLab Container Registry

```bash
docker login registry.gitlab.com

docker tag mi-app registry.gitlab.com/grupo/mi-app:1.0.0
docker push registry.gitlab.com/grupo/mi-app:1.0.0
```

### Amazon ECR (Elastic Container Registry)

```bash
aws ecr get-login-password --region us-east-1 | \
  docker login --username AWS --password-stdin 123456789.dkr.ecr.us-east-1.amazonaws.com

docker tag mi-app 123456789.dkr.ecr.us-east-1.amazonaws.com/mi-app:1.0.0
docker push 123456789.dkr.ecr.us-east-1.amazonaws.com/mi-app:1.0.0
```

### Azure Container Registry (ACR)

```bash
az acr login --name mi-registro

docker tag mi-app mi-registro.azurecr.io/mi-app:1.0.0
docker push mi-registro.azurecr.io/mi-app:1.0.0
```

---

## Troubleshooting

### Error: denied: requested access to the resource is denied

```
Error response from daemon: denied: requested access to the resource is denied
```

**Solución:**
- Verifica que estés logueado: `docker login`
- Verifica que usaste el nombre de usuario correcto en el tag
- Verifica que el repositorio es público o que tienes permisos de escritura

### Error: name unknown: repository not found

```
Error response from daemon: pull access denied for mi-usuario/mi-app, repository does not exist
```

**Solución:**
- Verifica que el nombre del repositorio es correcto
- Verifica que el repositorio es público (o que estás logueado)
- Verifica la capitilización del nombre

### Error: denied: You don't have the needed permissions to perform this push

**Solución:**
- Verifica que estés logueado con el usuario correcto: `docker logout` → `docker login`
- Verifica que el repositorio pertenece a tu usuario
- Si usas un token, verifica que tiene permisos de escritura

---

## Resumen

- **Docker Registry**: Almacén centralizado de imágenes Docker
- **Docker Hub**: Registro oficial, público y gratuito
- **Etiquetado**: Las imágenes se nombran como `[registro]/[usuario]/[nombre]:[tag]`
- **Push**: Subir imágenes locales a Docker Hub con `docker push`
- **Pull**: Descargar imágenes de Docker Hub con `docker pull`
- **Autenticación**: Usa `docker login` y tokens para mayor seguridad
- **Mejores prácticas**: Usa tags específicos, documenta, usa tokens, sé consciente del tamaño

---

## Próximos pasos

Ahora que sabes cómo usar Docker Hub, estaremos listos para:
- Crear pipelines de CI/CD que construyan y suban imágenes automáticamente
- Trabajar con orquestadores como Kubernetes que descargan imágenes de registros
- Usar registros privados en entornos empresariales
