# 2.5 Almacenamiento en Docker: Persistencia de Datos

## El Problema: Contenedores Efímeros

Los contenedores son por diseño **efímeros**, es decir, cualquier dato escrito en el sistema de ficheros de un contenedor, se perderá como lágrimas en la lluvia una vez este contenedor sea destruido.

## La Solución: Volúmenes

En algunos casos podremos querer tener **persistencia de datos**, de forma que aunque terminemos el contenedor y lo volvamos a crear, los datos sigan ahí. Para eso usaremos el sistema de **volúmenes de Docker**.

## Tipos de Almacenamiento Persistente

### Docker Volumes

Los volúmenes son el mecanismo preferido para persistir datos generados y utilizados por contenedores Docker.

#### Características:
- Gestionados completamente por Docker
- Almacenados en una parte del sistema de archivos del host
- Pueden ser compartidos entre múltiples contenedores
- Más fáciles de respaldar o migrar

#### Comandos:
```bash
# Crear un volumen
docker volume create mi-volumen

# Listar volúmenes
docker volume ls

# Inspeccionar un volumen
docker volume inspect mi-volumen

# Usar un volumen en un contenedor
docker run -v mi-volumen:/app/data imagen

# Eliminar un volumen
docker volume rm mi-volumen
```

### Bind Mounts

Los bind mounts permiten montar un directorio o archivo específico del host en el contenedor.

#### Características:
- Apuntan a una ruta específica en el host
- Útiles para desarrollo (sincronizar código en tiempo real)
- Menos portables que los volúmenes
- Dependen de la estructura del sistema de archivos del host

#### Uso:
```bash
# Montar un directorio del host
docker run -v /ruta/host:/ruta/contenedor imagen

# Sintaxis alternativa (más explícita)
docker run --mount type=bind,source=/ruta/host,target=/ruta/contenedor imagen
```

## Demostración Práctica

### Demo: Crear y usar un volumen

1. **Crear un volumen**
   ```bash
   docker volume create datos-app
   ```

2. **Crear un contenedor que utiliza el volumen**
   ```bash
   docker run -d --name contenedor1 -v datos-app:/data alpine sleep 3600
   ```

3. **Escribir datos en el volumen**
   ```bash
   docker exec contenedor1 sh -c "echo 'Datos persistentes' > /data/archivo.txt"
   ```

4. **Destruir el contenedor**
   ```bash
   docker rm -f contenedor1
   ```

5. **Crear un nuevo contenedor con el mismo volumen**
   ```bash
   docker run -d --name contenedor2 -v datos-app:/data alpine sleep 3600
   ```

6. **Verificar que los datos persisten**
   ```bash
   docker exec contenedor2 cat /data/archivo.txt
   ```

### Demo: Diferencia entre volumes y bind mount

#### Usando Volume:
```bash
docker volume create web-data
docker run -d -v web-data:/usr/share/nginx/html nginx
```

#### Usando Bind Mount:
```bash
docker run -d -v /home/usuario/mi-web:/usr/share/nginx/html nginx
```

**Diferencias clave:**
- El volume es gestionado por Docker, el bind mount apunta a una ruta específica
- El volume es más portable entre diferentes hosts
- El bind mount es útil para desarrollo (cambios en tiempo real)
- El bind mount requiere que la ruta exista en el host

## Cuándo Usar Cada Uno

### Usar Volumes cuando:
- Necesitas persistencia de datos en producción
- Quieres que Docker gestione el almacenamiento
- Necesitas compartir datos entre múltiples contenedores
- Requieres backups automáticos

### Usar Bind Mounts cuando:
- Estás en desarrollo y quieres cambios en tiempo real
- Necesitas acceso directo a los archivos desde el host
- La estructura de directorios del host es importante
